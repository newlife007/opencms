<!DOCTYPE html>
<html>
<head>
  <title>Admin Role Test</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .test { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
    .pass { background-color: #d4edda; }
    .fail { background-color: #f8d7da; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>OpenWan Admin Role Debug</h1>
  
  <h2>Test 1: Login API Response</h2>
  <div id="test1" class="test">Loading...</div>
  
  <h2>Test 2: Role Check Logic</h2>
  <div id="test2" class="test">
    <pre id="roleLogic"></pre>
  </div>
  
  <h2>Instructions</h2>
  <p>1. Open browser console (F12)</p>
  <p>2. Log out and log in again as admin user</p>
  <p>3. Check console for: "Login successful: { user: ..., roles: [...], token: ... }"</p>
  <p>4. The roles array should contain ["ADMIN"]</p>
  <p>5. After refresh, you should see "系统管理" menu</p>
  
  <script>
    // Test login API
    fetch('http://localhost:8080/api/v1/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: 'admin', password: 'test123' })
    })
    .then(r => r.json())
    .then(data => {
      const test1 = document.getElementById('test1');
      const hasRoles = data.user && data.user.roles && data.user.roles.length > 0;
      const isAdmin = hasRoles && data.user.roles.some(r => r.toUpperCase() === 'ADMIN');
      
      test1.className = 'test ' + (isAdmin ? 'pass' : 'fail');
      test1.innerHTML = `
        <strong>${isAdmin ? '✅ PASS' : '❌ FAIL'}</strong><br>
        API Response:<br>
        <pre>${JSON.stringify(data, null, 2)}</pre>
        <br>
        Roles: ${JSON.stringify(data.user?.roles || [])}
      `;
    })
    .catch(err => {
      document.getElementById('test1').innerHTML = `<strong>❌ ERROR</strong><br>${err.message}`;
    });
    
    // Test role checking logic
    const apiRoles = ['ADMIN'];
    const lowerRoles = apiRoles.map(r => r.toLowerCase());
    const isAdminOld = apiRoles.includes('admin');
    const isAdminNew = lowerRoles.includes('admin');
    
    document.getElementById('roleLogic').textContent = `
API返回的roles: ${JSON.stringify(apiRoles)}
转换为小写: ${JSON.stringify(lowerRoles)}

旧方法 (有bug):
  roles.includes('admin') = ${isAdminOld}

新方法 (已修复):
  roles.map(r => r.toLowerCase()).includes('admin') = ${isAdminNew}
    `;
    
    const test2 = document.getElementById('test2');
    test2.className = 'test ' + (isAdminNew ? 'pass' : 'fail');
  </script>
</body>
</html>
