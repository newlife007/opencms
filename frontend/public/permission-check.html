<!DOCTYPE html>
<html>
<head>
    <title>OpenWan ç”¨æˆ·æƒé™æ£€æŸ¥</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { color: #67c23a; font-weight: bold; }
        .error { color: #f56c6c; font-weight: bold; }
        .warning { color: #e6a23c; font-weight: bold; }
        .info { color: #409eff; font-weight: bold; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
        h2 { color: #303133; border-bottom: 2px solid #409eff; padding-bottom: 10px; }
        code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; }
        ul { line-height: 1.8; }
    </style>
</head>
<body>
    <h1>ğŸ” OpenWan ç”¨æˆ·æƒé™æ£€æŸ¥å·¥å…·</h1>
    
    <div class="card">
        <h2>é—®é¢˜åˆ†æ</h2>
        <p class="error">âŒ è®¿é—® /admin/* è·¯ç”±æ—¶è·³è½¬åˆ°äº† Dashboard</p>
        <p>è¿™è¯´æ˜ï¼š<strong>å½“å‰ç”¨æˆ·æ²¡æœ‰ç®¡ç†å‘˜æƒé™</strong></p>
        <p>è·¯ç”±å®ˆå«æ£€æµ‹åˆ° <code>requiresAdmin: true</code> ä½†ç”¨æˆ·ä¸æ˜¯adminï¼Œæ‰€ä»¥é‡å®šå‘åˆ° /dashboard</p>
    </div>

    <div class="card">
        <h2>æ£€æŸ¥æ­¥éª¤</h2>
        <h3>æ­¥éª¤1ï¼šæ‰“å¼€å¼€å‘è€…å·¥å…·</h3>
        <ol>
            <li>åœ¨ OpenWan å‰ç«¯é¡µé¢ï¼ˆhttp://localhost:3000/ï¼‰æŒ‰ <code>F12</code></li>
            <li>åˆ‡æ¢åˆ° <strong>Application</strong> æ ‡ç­¾ï¼ˆChromeï¼‰æˆ– <strong>Storage</strong> æ ‡ç­¾ï¼ˆFirefoxï¼‰</li>
            <li>å·¦ä¾§æ‰¾åˆ° <strong>Local Storage</strong> â†’ <code>http://localhost:3000</code></li>
            <li>æŸ¥çœ‹æ˜¯å¦æœ‰ <code>token</code> é”®</li>
        </ol>

        <h3>æ­¥éª¤2ï¼šæ£€æŸ¥ç”¨æˆ·ä¿¡æ¯</h3>
        <p>åœ¨ Console æ ‡ç­¾ä¸­æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š</p>
        <pre>
// æ–¹æ³•1ï¼šæ£€æŸ¥ localStorage
console.log('Token:', localStorage.getItem('token'));

// æ–¹æ³•2ï¼šæ£€æŸ¥ Pinia storeï¼ˆéœ€è¦åœ¨é¡µé¢åŠ è½½åæ‰§è¡Œï¼‰
// åˆ·æ–°é¡µé¢åç­‰å¾…å‡ ç§’ï¼Œç„¶åæ‰§è¡Œï¼š
const app = document.querySelector('#app').__vue_app__;
const pinia = app._context.provides[Symbol.for('pinia')];
const stores = pinia._s;
const userStore = Array.from(stores.values()).find(s => s.$id === 'user');

if (userStore) {
    console.log('âœ… User Store æ‰¾åˆ°');
    console.log('ç”¨æˆ·ä¿¡æ¯:', userStore.user);
    console.log('è§’è‰²åˆ—è¡¨:', userStore.roles);
    console.log('æƒé™åˆ—è¡¨:', userStore.permissions);
    console.log('æ˜¯å¦ç®¡ç†å‘˜:', userStore.isAdmin());
} else {
    console.log('âŒ User Store æœªæ‰¾åˆ°');
}
        </pre>
    </div>

    <div class="card">
        <h2>é¢„æœŸè¾“å‡º</h2>
        <p class="info">å¦‚æœç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼Œåº”è¯¥çœ‹åˆ°ï¼š</p>
        <pre>
âœ… User Store æ‰¾åˆ°
ç”¨æˆ·ä¿¡æ¯: { username: "admin", email: "admin@example.com", ... }
è§’è‰²åˆ—è¡¨: ["admin"]  æˆ–  ["system"]
æƒé™åˆ—è¡¨: [...]
æ˜¯å¦ç®¡ç†å‘˜: true
        </pre>

        <p class="error">å¦‚æœç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼Œä¼šçœ‹åˆ°ï¼š</p>
        <pre>
âœ… User Store æ‰¾åˆ°
ç”¨æˆ·ä¿¡æ¯: { username: "user1", email: "user@example.com", ... }
è§’è‰²åˆ—è¡¨: []  æˆ–  ["user", "editor"]
æƒé™åˆ—è¡¨: [...]
æ˜¯å¦ç®¡ç†å‘˜: false  â† è¿™å°±æ˜¯é—®é¢˜ï¼
        </pre>
    </div>

    <div class="card">
        <h2>ğŸ”§ è§£å†³æ–¹æ¡ˆ</h2>
        
        <h3>æ–¹æ¡ˆ1ï¼šä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•ï¼ˆæ¨èï¼‰</h3>
        <ol>
            <li>é€€å‡ºå½“å‰è´¦å·</li>
            <li>ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•ï¼ˆç”¨æˆ·åé€šå¸¸æ˜¯ <code>admin</code>ï¼‰</li>
            <li>ç™»å½•åå†æ¬¡è®¿é—® /admin/permissions</li>
        </ol>

        <h3>æ–¹æ¡ˆ2ï¼šç»™å½“å‰ç”¨æˆ·æ·»åŠ ç®¡ç†å‘˜è§’è‰²ï¼ˆéœ€è¦åç«¯æ“ä½œï¼‰</h3>
        <p>éœ€è¦åœ¨æ•°æ®åº“ä¸­ç»™å½“å‰ç”¨æˆ·åˆ†é…adminè§’è‰²ï¼š</p>
        <pre>
-- æŸ¥è¯¢å½“å‰ç”¨æˆ·IDï¼ˆå‡è®¾ç”¨æˆ·åæ˜¯ user1ï¼‰
SELECT id FROM ow_users WHERE username = 'user1';

-- æŸ¥è¯¢adminè§’è‰²ID
SELECT id FROM ow_roles WHERE name = 'admin';

-- æŸ¥è¯¢ç”¨æˆ·æ‰€å±ç»„
SELECT group_id FROM ow_users WHERE username = 'user1';

-- ç»™ç”¨æˆ·çš„ç»„åˆ†é…adminè§’è‰²ï¼ˆå‡è®¾ç”¨æˆ·ç»„IDæ˜¯2ï¼Œè§’è‰²IDæ˜¯1ï¼‰
INSERT INTO ow_groupshasroles (group_id, role_id) 
VALUES (2, 1) 
ON DUPLICATE KEY UPDATE group_id=group_id;
        </pre>

        <h3>æ–¹æ¡ˆ3ï¼šä¸´æ—¶ç§»é™¤requiresAdminæ£€æŸ¥ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰</h3>
        <p class="warning">âš ï¸ ä»…ç”¨äºå¼€å‘æµ‹è¯•ï¼Œä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼</p>
        <p>ä¿®æ”¹ <code>/frontend/src/router/index.js</code>ï¼š</p>
        <pre>
// æ‰¾åˆ°è¿™æ®µä»£ç ï¼ˆçº¦147è¡Œï¼‰ï¼š
if (to.meta.requiresAdmin && !userStore.isAdmin()) {
  next({ path: '/dashboard' })
  return
}

// ä¸´æ—¶æ³¨é‡Šæ‰ï¼š
// if (to.meta.requiresAdmin && !userStore.isAdmin()) {
//   next({ path: '/dashboard' })
//   return
// }
        </pre>
        <p>ä¿å­˜åViteä¼šè‡ªåŠ¨é‡æ–°åŠ è½½ã€‚</p>
    </div>

    <div class="card">
        <h2>ğŸ” æ£€æŸ¥èœå•æ˜¯å¦æ˜¾ç¤ºçš„é€»è¾‘</h2>
        <p>å³ä½¿è·¯ç”±å·²é…ç½®ï¼Œèœå•ä¹Ÿå¯èƒ½ä¸æ˜¾ç¤ºï¼Œå› ä¸º <code>MainLayout.vue</code> ä¸­æœ‰è¿‡æ»¤é€»è¾‘ï¼š</p>
        <pre>
const menuRoutes = computed(() => {
  const routes = router.options.routes.find(r => r.path === '/')?.children || []
  return routes.filter(route => {
    if (route.meta?.hidden) return false
    if (route.meta?.requiresAdmin && !userStore.isAdmin()) return false  â† è¿™é‡Œï¼
    return true
  })
})
        </pre>
        <p>å¦‚æœ <code>userStore.isAdmin()</code> è¿”å› falseï¼Œæ•´ä¸ª"ç³»ç»Ÿç®¡ç†"èœå•éƒ½ä¸ä¼šæ˜¾ç¤ºã€‚</p>
    </div>

    <div class="card">
        <h2>ğŸ“ å¿«é€Ÿæµ‹è¯•</h2>
        <p>åœ¨ Console ä¸­å¿«é€Ÿæµ‹è¯•å½“å‰ç”¨æˆ·æƒé™ï¼š</p>
        <pre>
// åˆ·æ–°é¡µé¢åæ‰§è¡Œ
setTimeout(() => {
    const app = document.querySelector('#app')?.__vue_app__;
    if (!app) {
        console.log('âŒ Vue app not found');
        return;
    }
    
    const pinia = app._context.provides[Symbol.for('pinia')];
    if (!pinia) {
        console.log('âŒ Pinia not found');
        return;
    }
    
    const userStore = Array.from(pinia._s.values()).find(s => s.$id === 'user');
    if (!userStore) {
        console.log('âŒ User store not found');
        return;
    }
    
    console.log('========== ç”¨æˆ·æƒé™æ£€æŸ¥ ==========');
    console.log('ğŸ‘¤ ç”¨æˆ·å:', userStore.user?.username || 'æœªç™»å½•');
    console.log('ğŸ“§ é‚®ç®±:', userStore.user?.email || 'N/A');
    console.log('ğŸ­ è§’è‰²:', userStore.roles);
    console.log('ğŸ”‘ æƒé™æ•°é‡:', userStore.permissions.length);
    console.log('ğŸ‘‘ æ˜¯å¦ç®¡ç†å‘˜:', userStore.isAdmin() ? 'âœ… æ˜¯' : 'âŒ å¦');
    console.log('=================================');
    
    if (!userStore.isAdmin()) {
        console.log('');
        console.log('âš ï¸  å½“å‰ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼');
        console.log('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š');
        console.log('   1. ä½¿ç”¨adminè´¦å·ç™»å½•');
        console.log('   2. æˆ–åœ¨æ•°æ®åº“ä¸­ç»™å½“å‰ç”¨æˆ·åˆ†é…adminè§’è‰²');
    }
}, 2000);
        </pre>
        <p>å¤åˆ¶ä¸Šé¢çš„ä»£ç ï¼Œåˆ·æ–°é¡µé¢åç²˜è´´åˆ°Consoleæ‰§è¡Œã€‚</p>
    </div>

    <div class="card">
        <h2>ğŸ“ ä¸‹ä¸€æ­¥</h2>
        <p class="info">è¯·å‘Šè¯‰æˆ‘ï¼š</p>
        <ul>
            <li>âœ… æ‰§è¡Œæ£€æŸ¥è„šæœ¬åï¼Œ<strong>æ˜¯å¦ç®¡ç†å‘˜</strong> æ˜¾ç¤ºä»€ä¹ˆï¼Ÿï¼ˆtrue/falseï¼‰</li>
            <li>âœ… <strong>è§’è‰²åˆ—è¡¨</strong> åŒ…å«ä»€ä¹ˆï¼Ÿï¼ˆ["admin"], ["user"], è¿˜æ˜¯ []ï¼‰</li>
            <li>âœ… å½“å‰ç™»å½•çš„<strong>ç”¨æˆ·å</strong>æ˜¯ä»€ä¹ˆï¼Ÿ</li>
        </ul>
        <p>æ ¹æ®ç»“æœï¼Œæˆ‘å¯ä»¥æä¾›æ›´å…·ä½“çš„è§£å†³æ–¹æ¡ˆï¼</p>
    </div>
</body>
</html>
