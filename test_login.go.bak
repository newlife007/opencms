package main

import (
	"crypto/md5"
	"encoding/hex"
	"fmt"
	"log"

	"gorm.io/driver/mysql"
	"gorm.io/gorm"
)

type User struct {
	ID       uint   `gorm:"column:id"`
	Username string `gorm:"column:username"`
	Password string `gorm:"column:password"`
	Email    string `gorm:"column:email"`
	Enabled  int    `gorm:"column:enabled"`
}

func (User) TableName() string {
	return "ow_users"
}

func checkPassword(password, hash string) bool {
	if len(hash) == 32 {
		h := md5.New()
		h.Write([]byte(password))
		computed := hex.EncodeToString(h.Sum(nil))
		return computed == hash
	}
	return false
}

func main() {
	// Connect to database
	dsn := "openwan:openwan123@tcp(172.21.0.2:3306)/openwan_db?charset=utf8mb4&parseTime=True&loc=Local"
	db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
	if err != nil {
		log.Fatal("Failed to connect:", err)
	}
	fmt.Println("✓ Connected to database")

	// Find admin user
	var user User
	if err := db.Where("username = ?", "admin").First(&user).Error; err != nil {
		log.Fatal("User not found:", err)
	}

	fmt.Printf("✓ Found user: %s (ID: %d)\n", user.Username, user.ID)
	fmt.Printf("  Email: %s\n", user.Email)
	fmt.Printf("  Password hash: %s\n", user.Password)
	fmt.Printf("  Enabled: %d\n", user.Enabled)

	// Test password verification
	testPasswords := []string{"admin", "admin123", "password", "openwan"}
	for _, pwd := range testPasswords {
		if checkPassword(pwd, user.Password) {
			fmt.Printf("\n✓ SUCCESS! Password '%s' matches!\n", pwd)
		} else {
			fmt.Printf("  ✗ Password '%s' does not match\n", pwd)
		}
	}
}
