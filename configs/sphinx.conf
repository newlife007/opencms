#
# Sphinx Configuration for OpenWan Media Asset Management System
# This configuration supports Chinese full-text search using UTF-8 encoding
#

# Main data source - indexes all published files
source main
{
	type				= mysql
	sql_host			= localhost
	sql_user			= root
	sql_pass			= 
	sql_db				= openwan_db
	sql_port			= 3306
	
	sql_query_pre		= SET NAMES utf8
	sql_query_pre		= SET SESSION query_cache_type=OFF
	
	# Main query - fetch all published files (status=2)
	sql_query			= \
		SELECT id, category_id, category_name, type, title, status, level, groups, \
		UNIX_TIMESTAMP(putout_at) AS putout_at, \
		UNIX_TIMESTAMP(upload_at) AS upload_at, \
		catalog_info \
		FROM ow_files WHERE status = 2
	
	# Attribute definitions for filtering
	sql_attr_uint		= category_id		# Category ID for filtering
	sql_attr_uint		= type				# File type: 1=video, 2=audio, 3=image, 4=rich media
	sql_attr_uint		= status			# Status: 0=new, 1=pending, 2=published, 3=rejected, 4=deleted
	sql_attr_uint		= level				# Browsing level for access control
	sql_attr_timestamp	= putout_at			# Publish date for date filtering
	sql_attr_timestamp	= upload_at			# Upload date for sorting
	
	# Info query for debugging
	sql_query_info		= SELECT * FROM ow_files WHERE id=$id
	
	# Range query for distributed indexing (optional)
	sql_query_range		= SELECT MIN(id), MAX(id) FROM ow_files WHERE status = 2
	sql_range_step		= 1000
}

# Delta source - indexes recently changed files for incremental updates
source delta : main
{
	# Query files modified in the last 24 hours
	sql_query			= \
		SELECT id, category_id, category_name, type, title, status, level, groups, \
		UNIX_TIMESTAMP(putout_at) AS putout_at, \
		UNIX_TIMESTAMP(upload_at) AS upload_at, \
		catalog_info \
		FROM ow_files \
		WHERE status = 2 \
		AND (upload_at > NOW() - INTERVAL 1 DAY OR catalog_at > NOW() - INTERVAL 1 DAY OR putout_at > NOW() - INTERVAL 1 DAY)
}

# Main index configuration
index main
{
	source				= main
	path				= /var/data/sphinx/openwan/main
	docinfo				= extern
	
	# Morphology settings
	morphology			= none
	min_word_len		= 1
	
	# Chinese tokenization settings
	charset_type		= utf-8
	
	# For CoreSeek/mmseg Chinese word segmentation
	# charset_dictpath	= /usr/local/mmseg3/etc/
	
	# NGram settings for Chinese (alternative to mmseg)
	ngram_len			= 1
	ngram_chars			= U+3000..U+2FA1F
	
	# HTML processing
	html_strip			= 1
	html_remove_elements = script, style
	
	# Memory settings
	min_prefix_len		= 0
	min_infix_len		= 0
	
	# Indexing settings
	index_exact_words	= 1
}

# Delta index for incremental updates
index delta : main
{
	source				= delta
	path				= /var/data/sphinx/openwan/delta
}

# Combined index for searching (main + delta)
index openwan
{
	type				= distributed
	local				= main
	local				= delta
}

# Indexer settings
indexer
{
	mem_limit			= 256M
	max_iops			= 40
	max_iosize			= 1048576
	write_buffer		= 1M
}

# Search daemon settings
searchd
{
	# SphinxQL port (MySQL protocol)
	listen				= 9306:mysql41
	
	# Binary API port (optional)
	listen				= 9312
	
	# Logging
	log					= /var/log/sphinx/searchd.log
	query_log			= /var/log/sphinx/query.log
	query_log_format	= sphinxql
	
	# PID file
	pid_file			= /var/run/sphinx/searchd.pid
	
	# Performance settings
	read_timeout		= 5
	client_timeout		= 300
	max_children		= 30
	max_matches			= 10000
	seamless_rotate		= 1
	preopen_indexes		= 1
	unlink_old			= 1
	
	# Query cache
	qcache_max_bytes	= 16M
	qcache_thresh_msec	= 1000
	qcache_ttl_sec		= 60
	
	# Threading
	workers				= threads # use thread_pool for better performance
	
	# Binlog for real-time updates (optional)
	binlog_path			= /var/data/sphinx/binlog
	binlog_flush		= 2
	binlog_max_log_size	= 256M
	
	# Network settings
	max_packet_size		= 32M
	mysql_version_string = 5.7.0
	
	# Collation (for ORDER BY string fields)
	collation_server	= utf8_general_ci
}

# Common section
common
{
	# Lemmatizer base path (optional)
	# lemmatizer_base = /usr/local/share/sphinx/
}
