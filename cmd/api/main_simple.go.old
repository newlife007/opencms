package main

import (
	"fmt"
	"log"
	"net/http"
	"os"

	"github.com/gin-gonic/gin"
)

func main() {
	// Set Gin mode
	gin.SetMode(gin.DebugMode)

	// Create router
	r := gin.Default()

	// CORS middleware
	r.Use(func(c *gin.Context) {
		c.Writer.Header().Set("Access-Control-Allow-Origin", "*")
		c.Writer.Header().Set("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS")
		c.Writer.Header().Set("Access-Control-Allow-Headers", "Content-Type, Authorization")
		
		if c.Request.Method == "OPTIONS" {
			c.AbortWithStatus(http.StatusOK)
			return
		}
		
		c.Next()
	})

	// Health check endpoints
	r.GET("/health", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"status":  "healthy",
			"service": "openwan-api",
			"version": "1.0.0",
		})
	})

	r.GET("/ready", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"status": "ready",
		})
	})

	r.GET("/alive", func(c *gin.Context) {
		c.JSON(http.StatusOK, gin.H{
			"status": "alive",
		})
	})

	// API routes
	api := r.Group("/api/v1")
	{
		// Ping endpoint
		api.GET("/ping", func(c *gin.Context) {
			c.JSON(http.StatusOK, gin.H{
				"success": true,
				"message": "pong",
			})
		})

		// Auth endpoints
		auth := api.Group("/auth")
		{
			auth.POST("/login", func(c *gin.Context) {
				// Simple mock login for testing
				var req struct {
					Username string `json:"username"`
					Password string `json:"password"`
				}
				
				if err := c.ShouldBindJSON(&req); err != nil {
					c.JSON(http.StatusBadRequest, gin.H{
						"success": false,
						"message": "Invalid request",
						"error":   err.Error(),
					})
					return
				}

				// Mock authentication
				if req.Username == "admin" && req.Password == "admin" {
					c.JSON(http.StatusOK, gin.H{
						"success": true,
						"message": "Login successful",
						"token":   "mock-token-123",
						"user": gin.H{
							"id":       1,
							"username": "admin",
							"is_admin": true,
						},
					})
				} else {
					c.JSON(http.StatusUnauthorized, gin.H{
						"success": false,
						"message": "Invalid credentials",
					})
				}
			})

			auth.GET("/me", func(c *gin.Context) {
				c.JSON(http.StatusOK, gin.H{
					"success": true,
					"user": gin.H{
						"id":       1,
						"username": "admin",
						"is_admin": true,
					},
				})
			})

			auth.POST("/logout", func(c *gin.Context) {
				c.JSON(http.StatusOK, gin.H{
					"success": true,
					"message": "Logout successful",
				})
			})
		}

		// Files endpoints
		files := api.Group("/files")
		{
			files.GET("", func(c *gin.Context) {
				c.JSON(http.StatusOK, gin.H{
					"success": true,
					"data":    []interface{}{},
					"total":   0,
					"page":    1,
					"page_size": 10,
				})
			})

			files.POST("/upload", func(c *gin.Context) {
				c.JSON(http.StatusOK, gin.H{
					"success": true,
					"message": "File uploaded successfully",
					"id":      1,
				})
			})

			files.GET("/:id", func(c *gin.Context) {
				c.JSON(http.StatusOK, gin.H{
					"success": true,
					"data": gin.H{
						"id":    c.Param("id"),
						"title": "Test File",
					},
				})
			})
		}

		// Categories endpoints
		categories := api.Group("/categories")
		{
			categories.GET("", func(c *gin.Context) {
				c.JSON(http.StatusOK, gin.H{
					"success": true,
					"data":    []interface{}{},
				})
			})

			categories.GET("/tree", func(c *gin.Context) {
				c.JSON(http.StatusOK, gin.H{
					"success": true,
					"data":    []interface{}{},
				})
			})
		}

		// Search endpoint
		api.POST("/search", func(c *gin.Context) {
			c.JSON(http.StatusOK, gin.H{
				"success": true,
				"results": []interface{}{},
				"total":   0,
			})
		})

		// Admin endpoints
		admin := api.Group("/admin")
		{
			admin.GET("/users", func(c *gin.Context) {
				c.JSON(http.StatusOK, gin.H{
					"success": true,
					"data":    []interface{}{},
				})
			})

			admin.GET("/groups", func(c *gin.Context) {
				c.JSON(http.StatusOK, gin.H{
					"success": true,
					"data":    []interface{}{},
				})
			})

			admin.GET("/roles", func(c *gin.Context) {
				c.JSON(http.StatusOK, gin.H{
					"success": true,
					"data":    []interface{}{},
				})
			})

			admin.GET("/permissions", func(c *gin.Context) {
				c.JSON(http.StatusOK, gin.H{
					"success": true,
					"data":    []interface{}{},
				})
			})
		}

		// Catalog endpoints
		catalog := api.Group("/catalog")
		{
			catalog.GET("/tree", func(c *gin.Context) {
				c.JSON(http.StatusOK, gin.H{
					"success": true,
					"data":    []interface{}{},
				})
			})
		}
	}

	// Get port from environment or use default
	port := os.Getenv("PORT")
	if port == "" {
		port = "8080"
	}

	// Start server
	addr := fmt.Sprintf(":%s", port)
	log.Printf("Starting OpenWan API Server on %s", addr)
	log.Printf("Health check: http://localhost%s/health", addr)
	log.Printf("API endpoint: http://localhost%s/api/v1/ping", addr)
	
	if err := r.Run(addr); err != nil {
		log.Fatal("Failed to start server:", err)
	}
}
